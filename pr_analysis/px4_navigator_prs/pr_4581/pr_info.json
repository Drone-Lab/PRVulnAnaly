{
  "title": "adjust stack sizes and cleanup ignored warnings",
  "url": "https://github.com/PX4/PX4-Autopilot/pull/4581",
  "number": 4581,
  "created_at": "2016-05-19T19:09:46Z",
  "merged": false,
  "merged_at": null,
  "state": "closed",
  "conversation": {
    "author": "dagar",
    "body": "I enabled   CONFIG_ARMV7M_STACKCHECK and adjusted some of the insufficient stack sizes I saw. There are still more modules to check and I still did get the system fully running. Once we have a hardware test harness I think we should have a build with stackcheck enabled. Alternatively if the overhead is acceptable we could keep it enabled on px4fmu-v4.\n",
    "issue_comments": [
      {
        "author": "LorenzMeier",
        "created_at": "2016-05-19T19:43:19Z",
        "body": "Thanks, this is awesome!\n",
        "type": "issue_comment"
      },
      {
        "author": "LorenzMeier",
        "created_at": "2016-05-19T19:45:20Z",
        "body": "The main reason to not have it on by default is that it draws a ton of CPU power. But we should indeed have proper test runs. The fact that you adjusted so much clearly shows that we have an unresolved process issue here.\n",
        "type": "issue_comment"
      },
      {
        "author": "LorenzMeier",
        "created_at": "2016-05-19T19:49:58Z",
        "body": "Rebased and applied.\n",
        "type": "issue_comment"
      },
      {
        "author": "dagar",
        "created_at": "2016-05-19T19:56:16Z",
        "body": "The NuttX wiki claims 30% to 35% additional CPU utilization which is huge, but maybe better than the alternative?\n\nI should emphasize this was only with a pixhawk configured for fixed wing and I didn't even get the system fully booted. I'm guessing there's going to be a lot more.\n",
        "type": "issue_comment"
      },
      {
        "author": "LorenzMeier",
        "created_at": "2016-05-19T20:09:06Z",
        "body": "@dagar The other thing to keep in mind is that the instrumentation itself draws memory. So this could be all a false alarm. The reported usage of the high watermarks in top is pretty accurate.\n",
        "type": "issue_comment"
      },
      {
        "author": "davids5",
        "created_at": "2016-05-19T20:34:42Z",
        "body": "@LorenzMeier and @dagar \nI may need revisit the headroom on master....\nThe water mark is large. If we have plenty or RAM then the \"larger than needed headroom\" is moot. If not, the values gleaned from `top` will be a good indicator of penetration just not large chunk overflow.\n",
        "type": "issue_comment"
      },
      {
        "author": "dagar",
        "created_at": "2016-05-19T23:10:44Z",
        "body": "Alright we won't panic over these potential stack issues, but for peace of mind let's work towards a build that runs cleanly with stack check enabled. I've added the idea to the testing wishlist #4532.\n",
        "type": "issue_comment"
      }
    ],
    "review_comments": [
      {
        "author": "LorenzMeier",
        "created_at": "2016-05-19T19:42:14Z",
        "body": "That's a steep increase - does the start handler really need more stack? Or did you intent to increase the main app stack? Which would be in task_spawn, NOT here.\n",
        "path": "src/modules/sensors/CMakeLists.txt",
        "position": 5,
        "type": "review_comment"
      },
      {
        "author": "LorenzMeier",
        "created_at": "2016-05-19T19:47:27Z",
        "body": "Disregard that - I'm pretty sure its valid and intended.\n",
        "path": "src/modules/sensors/CMakeLists.txt",
        "position": 5,
        "type": "review_comment"
      },
      {
        "author": "dagar",
        "created_at": "2016-05-19T19:50:28Z",
        "body": "This shouldn't have made it in. When stackcheck is enabled sensors is somehow causing a hard fault when the main exits. I tried throwing a ton of stack at it.\n",
        "path": "src/modules/sensors/CMakeLists.txt",
        "position": 5,
        "type": "review_comment"
      },
      {
        "author": "LorenzMeier",
        "created_at": "2016-05-19T19:58:50Z",
        "body": "Are you sure its causing a hard fault or rather entering the stack check trap?\n",
        "path": "src/modules/sensors/CMakeLists.txt",
        "position": 5,
        "type": "review_comment"
      },
      {
        "author": "LorenzMeier",
        "created_at": "2016-05-19T20:01:37Z",
        "body": "I've reset it for now to 1200. But I would appreciate your feedback.\n",
        "path": "src/modules/sensors/CMakeLists.txt",
        "position": 5,
        "type": "review_comment"
      },
      {
        "author": "dagar",
        "created_at": "2016-05-19T23:15:02Z",
        "body": "It was a hard fault in up_switchcontext.S according to the PC.\n",
        "path": "src/modules/sensors/CMakeLists.txt",
        "position": 5,
        "type": "review_comment"
      }
    ],
    "reviews": []
  }
}