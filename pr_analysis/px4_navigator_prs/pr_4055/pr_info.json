{
  "title": "VTOL_TAKEOFF, VTOL_LAND commands and VT_FORCE_VTOL param",
  "url": "https://github.com/PX4/PX4-Autopilot/pull/4055",
  "number": 4055,
  "created_at": "2016-03-22T10:30:16Z",
  "merged": false,
  "merged_at": null,
  "state": "closed",
  "conversation": {
    "author": "sanderux",
    "body": "support for MAV_CMD_NAV_VTOL_TAKEOFF and MAV_CMD_NAV_VTOL_LAND \nAlso implement VT_FORCE_VTOL to force land as VTOL\nreplaces https://github.com/PX4/Firmware/pull/3720\n\nFixes #3492\nFixes #3712\n",
    "issue_comments": [
      {
        "author": "sanderux",
        "created_at": "2016-03-24T00:14:26Z",
        "body": "@AndreasAntener I cleaned up the mission code, sanitized the functionality, improved back transition behavior, fixed alignment and implemented force_vtol procedure.\nSITL tested all reasonable scenarios and regression tested on the old procedure (takeoff -> trans -> wp -> trans -> land).\n\nI'm especially happy with the back transition improvement, we could see if the basis could change from time to velocity but for now this seems to be a big improvement.\n\nI will test fly this tree soon but i think it is ready to rebase and merge as i see no possible regression and it only implements previously unsupported functionality.\n\nSomehow this tagged along through a submodule init and causes travis to fail: https://github.com/PX4/Firmware/pull/4055/files#diff-d62dbab64e619e0e5926b64585204efdR1\nI think that should be resolved by rebasing but i'm not sure.\n\n/cc @LorenzMeier @tumbili \n",
        "type": "issue_comment"
      },
      {
        "author": "AndreasAntener",
        "created_at": "2016-03-24T09:04:46Z",
        "body": "@sanderux Could you rebase and squash the development commits? There are also wrong indentations in the mission code it seems\n",
        "type": "issue_comment"
      },
      {
        "author": "LorenzMeier",
        "created_at": "2016-03-24T11:02:40Z",
        "body": "@AndreasAntener @sanderux There is a 15 character limit on parameter length, what I proposed works, what you proposed doesn't.\n",
        "type": "issue_comment"
      },
      {
        "author": "sanderux",
        "created_at": "2016-03-24T11:11:00Z",
        "body": "@LorenzMeier I tested VT_NAV_FORCE_VTL as param and that works. Do you want me to change it?\n",
        "type": "issue_comment"
      },
      {
        "author": "LorenzMeier",
        "created_at": "2016-03-24T11:13:09Z",
        "body": "16 is the hard limit without NUL-termination. It should work, but you can get yourself into corner cases in downstream implementations. I suggest to use VT_NAV_FORCE_VT instead.\n",
        "type": "issue_comment"
      },
      {
        "author": "sanderux",
        "created_at": "2016-03-24T11:20:04Z",
        "body": "ready to merge\n",
        "type": "issue_comment"
      },
      {
        "author": "LorenzMeier",
        "created_at": "2016-03-24T12:03:20Z",
        "body": "Is this state SITL and outdoor tested? I think it should be, as the changes are significant.\n",
        "type": "issue_comment"
      },
      {
        "author": "sanderux",
        "created_at": "2016-03-24T12:10:05Z",
        "body": "Sitl is tested, outdoor tomorrow\n",
        "type": "issue_comment"
      },
      {
        "author": "sanderux",
        "created_at": "2016-03-25T20:34:02Z",
        "body": "Outdoor tested in quite strong wind. \nhttp://logs.uaventure.com/view/JRG4pRghKoV3RK8eS3o75k#AS_Yaw_PLOT\n\n1 There was a sudden unintended yaw action when front transition started, see yaw setpoint change\n2 Very smooth back transition but quite a high time and in strong winds it drifts a lot \n3 During lading it weathervaned and got lift from it's wings, it therefor acted up a little.\n",
        "type": "issue_comment"
      },
      {
        "author": "sanderux",
        "created_at": "2016-03-25T21:49:39Z",
        "body": "Here is a second log:\nhttp://logs.uaventure.com/view/PJYu2ARidpuQyFsX9qxdKm\n\nThe yaw setpoint issue is consistent\nThe airspeed sensor for the quadranger acted up here (turned out to be the radio telem being too close)\n",
        "type": "issue_comment"
      },
      {
        "author": "sanderux",
        "created_at": "2016-03-26T18:04:08Z",
        "body": "This should fix the yaw issue during transition\n",
        "type": "issue_comment"
      },
      {
        "author": "AndreasAntener",
        "created_at": "2016-03-27T01:13:09Z",
        "body": "@sanderux before I forget, mission item reached: one reason to not wait on the transition to be finished is that the position controller won't know the next waypoint and therefore cannot control the position during the transition in case we later implement this. haven't thought about it in detail though.\n",
        "type": "issue_comment"
      },
      {
        "author": "sanderux",
        "created_at": "2016-03-27T08:16:59Z",
        "body": "the advantage of this command is that the user can point the vehicle into the wind. It is basically the autonomous equivlant of flicking the aux1 switch.\n\nFor position control it should hold altitude and heading until ttansition has completed or timeout occurs. \n",
        "type": "issue_comment"
      },
      {
        "author": "AndreasAntener",
        "created_at": "2016-03-27T09:34:31Z",
        "body": "Sure but it's changing the behaviour in general, also for the separate transitions (not part of VTOL tko/lnd). What we talked about yesterday, if we want the FW position controller to guide it through blending, it needs to know the next waypoint. If it doesn't get the actual next mission waypoint, we need to generate a temporary waypoint that lies in the direction of the target transition heading. Another option would be to look at the \"next\" waypoint in the triplet, which contains the next position during the transition. Ok, I think we have 2 good options here so it's fine.\n\nNote: simply holding heading and attitude is not going to work, it will drift off path.\n",
        "type": "issue_comment"
      },
      {
        "author": "sanderux",
        "created_at": "2016-03-27T09:45:41Z",
        "body": "Yes your right, i think a temp waypoint would be a good idea.\n",
        "type": "issue_comment"
      },
      {
        "author": "LorenzMeier",
        "created_at": "2016-03-27T10:27:38Z",
        "body": "Waiting for conclusive test flights to merge this.\n",
        "type": "issue_comment"
      },
      {
        "author": "AndreasAntener",
        "created_at": "2016-03-27T10:31:39Z",
        "body": "I did a sitl test to check on the Z velocity issue that i see in your log from #4079:\n\n<img width=\"1368\" alt=\"screen shot 2016-03-27 at 12 15 55\" src=\"https://cloud.githubusercontent.com/assets/5750020/14064961/98febe76-f416-11e5-9277-f6557dca7d42.png\">\n\nThe position controller still sees a takeoff type setpoint during the transition. Needs to be reset, should be a small fix.\n",
        "type": "issue_comment"
      },
      {
        "author": "sanderux",
        "created_at": "2016-03-27T23:48:12Z",
        "body": "@AndreasAntener do you agree on the location of setting the setpoint type?\n",
        "type": "issue_comment"
      },
      {
        "author": "sanderux",
        "created_at": "2016-03-29T21:06:49Z",
        "body": "@AndreasAntener i added the virtual waypoint in front of the takeoff item. This should work fine now with your transition position holding\n",
        "type": "issue_comment"
      },
      {
        "author": "sanderux",
        "created_at": "2016-03-30T11:51:22Z",
        "body": "Here is a log for a SITL flight based on this branch combined with https://github.com/PX4/Firmware/pull/4093. looks very smooth and functions as expected.\nhttp://logs.uaventure.com/view/VXJnLmimbG8px8aiuPtBja\n\n![image](https://cloud.githubusercontent.com/assets/14801663/14141202/fab81b6c-f67d-11e5-8f05-aa66601c9d1f.png)\n",
        "type": "issue_comment"
      },
      {
        "author": "sanderux",
        "created_at": "2016-04-02T18:20:36Z",
        "body": "Outdoor tested, looking good:\nhttp://logs.uaventure.com/view/jg2rHZDRmAboYLiqyFVuge\nVideo: https://drive.google.com/file/d/0B27AvDmVit4KQlpCMllyaDVxQmM/view?usp=sharing\n",
        "type": "issue_comment"
      },
      {
        "author": "LorenzMeier",
        "created_at": "2016-04-02T20:29:55Z",
        "body": "Rebased and applied, thanks!\n",
        "type": "issue_comment"
      }
    ],
    "review_comments": [
      {
        "author": "LorenzMeier",
        "created_at": "2016-03-24T08:31:49Z",
        "body": "This should be defined in the navigator params, (NAV_FORCE_VTOL), as its only used there.\n",
        "path": "src/modules/vtol_att_control/vtol_att_control_params.c",
        "position": 1,
        "type": "review_comment"
      },
      {
        "author": "sanderux",
        "created_at": "2016-03-24T08:59:09Z",
        "body": "All vtol related params start with VT_ perhaps VT_NAV_FORCE_VTOL ?\n",
        "path": "src/modules/vtol_att_control/vtol_att_control_params.c",
        "position": 1,
        "type": "review_comment"
      }
    ],
    "reviews": []
  }
}